name: Pull the image with it's latest tag, apply new tags and push back to container registry

on:
  workflow_call:
    inputs:
      image:
        description: Image name
        required: true
        type: string
      registry:
        description: The list of tags space separated values
        required: false
        type: string
        default: "ghcr.io"
      runs-on:
        description: GitHub Actions Runner image
        required: true
        type: string
    secrets:
      registry_username:
        required: true
      registry_token:
        required: true

defaults:
  run:
    working-directory: ./docker-stacks
    
jobs:
  tag-push:
    runs-on: ${{ inputs.runs-on }}
    name: ${{ inputs.image }}

    steps:
      - name: Checkout Repo âš¡ï¸
        uses: actions/checkout@v4
      
      - name: Setup dev env patchs ðŸ“¦
        uses: ./.github/actions/install-patchs-and-extension

      - name: Create dev environment ðŸ“¦
        uses: ./docker-stacks/.github/actions/create-dev-env
  
      - name: Login to Registry ðŸ”
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.registry }}
          username: ${{ secrets.registry_username }}
          password: ${{ secrets.registry_token }}

      - name: Pull latest tag image ðŸ“¥
        run: docker pull ${{ inputs.registry }}/${{ github.repository_owner }}/${{ inputs.image }}
        shell: bash

      - name: Apply tags to the loaded image ðŸ·
        run: python3 -m extension.tagging.apply_tags --short-image-name ${{ inputs.image }} --registry ${{ inputs.registry }} --owner ${{ github.repository_owner }}
      
      - name: Prepare image push ðŸ“¦
        run: |
          # The short image name (without tag) is necessary to push to the registry
          echo "SHORT_IMAGE_NAME=${{ inputs.image }}" | awk -F: '{print $1}' >> $GITHUB_ENV
        shell: bash

      - name: Push Images to Registry ðŸ“¤
        run: docker push --all-tags ${{ inputs.registry }}/${{ github.repository_owner }}/$SHORT_IMAGE_NAME
        shell: bash
