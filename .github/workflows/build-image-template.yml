name: Jupyter build single arch image template

on:
  workflow_call:
    inputs:
      parent-image:
        description: Parent image name
        required: true
        type: string
      image:
        description: Image name like "my-image:tag"
        required: true
        type: string
      publish_to_registry:
        description: Wheter to push to the registry
        required: false
        type: string
        default: false
      ci_registry:
        description: The registry used to push ci images
        required: false
        type: string
        default: ghcr.io
      registry:
        description: The container registry 
        required: false
        type: string
        default: quay.io
      build-args:
        description: Build args comma separated list, ex. PYTHON_VERSION=3.11, ...
        required: false
        type: string
      git_latest_release_tag:
        description: The latest remote release tag 
        required: false
        type: string
        default: ""
      runs-on:
        description: GitHub Actions Runner image
        required: true
        type: string
      platform:
        description: Image platform (x86_64 or aarch64)
        required: true
        type: string

defaults:
  run:
    working-directory: ./docker-stacks

jobs:
  build-test:
    name: ${{ inputs.platform }}-${{ inputs.image }}
    runs-on: ${{ inputs.runs-on }}
  
    steps:
      ### The publish and periodic rebuilds are based on the latest stable github release tag
      - name: Checkout latest Github Release tag (${{ inputs.git_latest_release_tag }}) ‚ö°Ô∏è
        if: inputs.publish_to_registry == 'true'
        uses: actions/checkout@v5
        with:
          ref: ${{ inputs.git_latest_release_tag }}

      - name: Checkout Repo ‚ö°Ô∏è
        if: inputs.publish_to_registry == 'false'
        uses: actions/checkout@v5

      # For cuda images only
      # - name: Free up disk space üì¶
      #  if: env.ACT != 'true'
      #  uses: ./.github/actions/free-disk-space

      - name: Patch create a build environment
        uses: ./.github/actions/patch-create-dev-env

      - name: Create dev environment üì¶
        # We need to have a recent docker version
        # More info: https://github.com/jupyter/docker-stacks/pull/2255
        # Can be removed after Docker Engine is updated
        # https://github.com/actions/runner-images/issues/11766
        #uses: ./docker-stacks/.github/actions/create-dev-env
        uses: ./.github/actions/create-dev-env

      - name: Setup dev env patchs üì¶
        uses: ./.github/actions/install-okdp-extension

      - name: Login to the CI registry üîê
        if: inputs.publish_to_registry == 'false'
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.ci_registry }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login into official registry üîê
        if: inputs.publish_to_registry == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.registry }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_ROBOT_TOKEN }}

      - name: Set CI Github container registry namespace
        if: inputs.publish_to_registry == 'false'
        run:  |
          echo "OWNER=${GITHUB_REPOSITORY_OWNER@L}" >> $GITHUB_ENV
          echo "REGISTRY=${{ inputs.ci_registry }}" >> $GITHUB_ENV
        shell: bash

      - name: Set official publish container registry namespace
        if: inputs.publish_to_registry == 'true'
        run:  |
          echo "OWNER=${GITHUB_REPOSITORY_OWNER@L}/jupyter" >> $GITHUB_ENV
          echo "REGISTRY=${{ inputs.registry }}" >> $GITHUB_ENV
        shell: bash

      - name: Pull parent image üì•
        if: inputs.parent-image != ''
        run: docker pull $REGISTRY/$OWNER/${{ inputs.parent-image }}-${{ inputs.platform }}
        shell: bash
        
      - name: Prepare image build (build-args) üì¶
        run: |
          for build_arg in ${{ inputs.build-args }}
          do
            BUILD_ARGS+="--build-arg $build_arg "
          done
          if [[ "${{ inputs.parent-image }}" ]]
          then
            BUILD_ARGS+="--build-arg BASE_IMAGE=$REGISTRY/$OWNER/${{ inputs.parent-image }}-${{ inputs.platform }} "
          fi
          echo "BUILD_ARGS=$BUILD_ARGS" >> $GITHUB_ENV
          # The short image name is necessary to run the tests (not pushed, local to jobs only)
          echo "SHORT_IMAGE_NAME=${{ inputs.image }}" | awk -F: '{print $1}' >> $GITHUB_ENV
        shell: bash

      - name: Patch PySpark Dockerfile to be compatible with java +11 üì¶
        if: contains(inputs.image, 'pyspark-notebook:') && contains(inputs.build-args, 'spark_version=3.2.') && ! contains(inputs.build-args, 'openjdk_version=8')
        run: |
          cat pyspark-notebook/Dockerfile.spark3.2.x >> docker-stacks/images/$SHORT_IMAGE_NAME/Dockerfile
        working-directory: ./
        shell: bash

      - name: Add additional libraries üì¶
        run: |
          if test -f "$SHORT_IMAGE_NAME/Dockerfile"
          then
            cat $SHORT_IMAGE_NAME/Dockerfile >> docker-stacks/images/$SHORT_IMAGE_NAME/Dockerfile
            cd $SHORT_IMAGE_NAME
            cp $(ls | grep -v Dockerfile) ../docker-stacks/images/$SHORT_IMAGE_NAME/
          fi
        working-directory: ./
        shell: bash

      - name: Download Spark distribution into Github release (spark-tarballs) ‚¨áÔ∏è
        if: ${{ env.ACT != 'true' && contains(inputs.image, 'pyspark-notebook') }}
        uses: ./.github/actions/download-spark
        with:
          build-args: ${{ inputs.build-args }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build image üõ†
        run: |
          docker build --rm --force-rm --tag $REGISTRY/$OWNER/${{ inputs.image }}-${{ inputs.platform }} \
            --tag $REGISTRY/$OWNER/$SHORT_IMAGE_NAME:latest images/$SHORT_IMAGE_NAME/ \
            --build-arg REGISTRY=$REGISTRY \
            --build-arg OWNER=$OWNER $BUILD_ARGS \
            --label "org.opencontainers.image.source=https://github.com/${{ github.repository }}" \
            --label "org.opencontainers.image.description=$SHORT_IMAGE_NAME"
        env:
          DOCKER_BUILDKIT: 1
          # Full logs for CI build
          BUILDKIT_PROGRESS: plain
        shell: bash

      # Run docker-stacks tests (docker-stacks/tests)
      - name: Run tests ‚úÖ
        # Skip tests when running with ACT
        if: inputs.publish_to_registry == 'false' && env.ACT_SKIP_TESTS == ''
        run: |
           python3 -m tests.run_tests --image $SHORT_IMAGE_NAME --registry ${{ inputs.ci_registry }} --owner $OWNER
        shell: bash

      - name: Push to ci registry (${{ inputs.ci_registry }}) üì§
        if: inputs.publish_to_registry == 'false'
        run: |
           docker push ${{ inputs.ci_registry }}/$OWNER/${{ inputs.image }}-${{ inputs.platform }}
        shell: bash

      - name: Push to public registry (${{ inputs.registry }}) üì§
        if: inputs.publish_to_registry == 'true'
        run: |
           docker push ${{ inputs.registry }}/$OWNER/${{ inputs.image }}-${{ inputs.platform }}
        shell: bash
